<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>Skyforgia |> Ticket Detail</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/static/favicon-96x96.webp" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
  <link rel="shortcut icon" href="/static/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.webp" />
  <link rel="manifest" href="/static/site.webmanifest" />

  <!-- Open Graph -->
  <meta property="og:title" content="Skyforgia">
  <meta property="og:description" content="Free bot discord & whatsapp hosting.">
  <meta property="og:image" content="https://control.skyforgia.biz.id/static/logo-512x512.webp">
  <meta property="og:url" content="https://control.skyforgia.biz.id">
  <meta property="og:type" content="website">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Skyforgia">
  <meta name="twitter:description" content="Free bot discord & whatsapp hosting.">
  <meta name="twitter:image" content="https://control.skyforgia.biz.id/static/logo-512x512.webp">

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "url": "https://control.skyforgia.biz.id",
    "logo": "https://control.skyforgia.biz.id/static/logo-512x512.webp",
    "name": "Skyforgia"
  }
  </script>

  <style>
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in-up { animation: fadeInUp 0.4s ease-out forwards; }
  </style>
</head>
<body class="bg-gradient-to-br from-white to-blue-100 min-h-screen flex flex-col">

<!-- HEADER -->
<header class="bg-white border-b border-gray-200 py-3">
  <div class="max-w-screen-lg mx-auto flex justify-between items-center px-4">
    <a href="/getstarted" class="flex items-center space-x-2">
      <img src="/static/logo2.webp" alt="Logo" class="h-10" />
      <span class="text-2xl font-bold text-gray-800">Skyforgia</span>
    </a>
    <div class="flex items-center space-x-3">
      <i class="fa-solid fa-shield-halved text-gray-600 text-lg"></i>
    </div>
  </div>
</header>

<!-- MAIN -->
<main class="flex-grow px-4 py-8 animate-fadeInUp">
  <div class="grid md:grid-cols-3 gap-6 max-w-screen-xl mx-auto">
    
    <!-- LEFT PANEL -->
    <div class="bg-gradient-to-br from-blue-600 to-blue-800 text-white rounded-2xl shadow-xl p-6 space-y-4">
      <h2 class="text-xl font-bold">Ticket Info</h2>

      <p class="text-sm"><b>ID:</b> #{{ ticket.id }}</p>
      <p class="text-sm break-all"><b>Email:</b> {{ ticket.user_email }}</p>
      <p class="text-sm"><b>Category:</b> {{ ticket.category }}</p>
      <p class="text-sm"><b>Status:</b> <span class="font-bold">{{ ticket.status }}</span></p>

      {% if ticket.status == 'Open' %}
      <div class="bg-yellow-200/20 border-l-4 border-yellow-400 text-yellow-100 p-3 rounded-md text-xs">
        Our team may take up to <b>7 business days</b> to reply. Thanks for your patience!
      </div>
      {% endif %}

      {% if user.email == admin_mail %}
      <div class="pt-3">
        <h3 class="text-sm font-semibold mb-2">Update Status</h3>
        <div class="grid grid-cols-2 gap-2 text-xs">
          <a href="/ticket/{{ ticket.id }}/status/Open" class="py-1.5 bg-green-500 hover:bg-green-600 text-white rounded-lg text-center">Open</a>
          <a href="/ticket/{{ ticket.id }}/status/In Progress" class="py-1.5 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg text-center">In Progress</a>
          <a href="/ticket/{{ ticket.id }}/status/Resolved" class="py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-center">Resolved</a>
          <a href="/ticket/{{ ticket.id }}/status/Rejected" class="py-1.5 bg-red-500 hover:bg-red-600 text-white rounded-lg text-center">Rejected</a>
          <a href="/ticket/{{ ticket.id }}/status/Closed" class="col-span-2 py-1.5 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-center">Closed</a>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- RIGHT PANEL -->
    <div class="bg-white md:col-span-2 rounded-2xl border shadow-xl flex flex-col overflow-hidden">
      
      <!-- Header -->
      <div class="border-b p-4">
        <h1 class="text-lg font-bold text-gray-800">{{ ticket.subject }}</h1>
      </div>

      <!-- Chat messages -->
      <div id="replies-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
        {% for reply in replies %}
        <div class="flex {% if reply.sender == 'admin' %}justify-end{% else %}justify-start{% endif %}">
          <div class="max-w-[80%] text-sm p-3 rounded-xl shadow-sm 
            {% if reply.sender == 'admin' %}
              bg-blue-600 text-white rounded-br-none
            {% else %}
              bg-gray-200 text-gray-800 rounded-bl-none
            {% endif %}">
            <b>{{ reply.sender|capitalize }}:</b> {{ reply.message }}
            
            {% for img in reply.images %}
              <img src="{{ img.image_url }}" class="mt-2 rounded-md shadow max-h-40">
            {% endfor %}

            <p class="text-[10px] opacity-70 mt-1 text-right">{{ reply.created_at.strftime("%Y-%m-%d %H:%M") }}</p>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Reply form -->
      <form id="reply-form" method="POST" enctype="multipart/form-data" 
            class="border-t p-3 flex items-center gap-2 bg-white">
        
        {% if user.email == admin_mail %}
          <input type="hidden" name="sender" value="admin">
        {% else %}
          <input type="hidden" name="sender" value="user">
        {% endif %}

        <input type="text" name="message" placeholder="Write a message..."
          class="flex-grow border rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-400 text-sm" required>

        <input type="file" name="images" accept="image/*" multiple
          id="file-input" class="hidden">

        <button type="button" id="file-button"
          class="w-9 h-9 rounded-xl bg-gray-200 hover:bg-gray-300 flex items-center justify-center">
          <i class="fa-solid fa-paperclip text-sm"></i>
        </button>

        <button type="submit"
          class="w-9 h-9 rounded-xl bg-blue-600 hover:bg-blue-700 text-white flex items-center justify-center">
          <i class="fa-solid fa-paper-plane text-sm"></i>
        </button>
      </form>

      <div id="preview-container" class="px-3 pb-3 flex flex-wrap gap-2"></div>
    </div>
  </div>
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const replyForm = document.getElementById("reply-form");
  const repliesContainer = document.getElementById("replies-container");
  const fileInput = document.getElementById("file-input");
  const fileButton = document.getElementById("file-button");
  const previewContainer = document.getElementById("preview-container");

  let selectedFiles = [];

  // ðŸ“œ Scroll ke bawah saat halaman dimuat
  setTimeout(() => {
    repliesContainer.scrollTo({
      top: repliesContainer.scrollHeight,
      behavior: "smooth"
    });
  }, 200);

  fileButton.addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", () => {
    selectedFiles = Array.from(fileInput.files);
    renderPreviews();
  });

  function renderPreviews() {
    previewContainer.innerHTML = "";
    selectedFiles.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const wrapper = document.createElement("div");
        wrapper.className = "relative inline-block";

        const img = document.createElement("img");
        img.src = e.target.result;
        img.className = "w-20 h-20 object-cover rounded-lg shadow";

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.innerHTML = "âŒ";
        removeBtn.className = "absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center";
        removeBtn.addEventListener("click", () => {
          selectedFiles.splice(index, 1);
          renderPreviews();
        });

        wrapper.appendChild(img);
        wrapper.appendChild(removeBtn);
        previewContainer.appendChild(wrapper);
      };
      reader.readAsDataURL(file);
    });
  }

  replyForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData();
    formData.append("sender", replyForm.querySelector("input[name='sender']").value);
    formData.append("message", replyForm.querySelector("input[name='message']").value);

    selectedFiles.forEach(file => formData.append("images", file));

    const response = await fetch(window.location.pathname, {
      method: "POST",
      body: formData
    });

    if (response.ok) {
      const data = await response.json();
      const newReply = document.createElement("div");
      newReply.className = `${data.sender === 'admin' ? 'text-right' : 'text-left'} fade-in-up`;

      let html = "";
      if (data.message) {
        html += `
          <p class="px-2.5 py-1.5 inline-block rounded-lg break-words max-w-[85%] sm:max-w-[65%] text-sm sm:text-base ${data.sender === 'admin' ? 'bg-blue-500 text-white' : 'bg-gray-300'}">
            <b>${data.sender.charAt(0).toUpperCase() + data.sender.slice(1)}:</b> ${data.message}
          </p><br>`;
      }

      if (data.images && data.images.length > 0) {
        html += data.images.map(url =>
          `<img src="${url}" alt="Attachment" class="inline-block max-w-[70%] sm:max-w-[200px] rounded-lg mt-1 shadow">`
        ).join("");
      }

      html += `<p class="text-xs text-gray-500 mt-1">${data.created_at}</p>`;
      newReply.innerHTML = html;

      repliesContainer.appendChild(newReply);
      repliesContainer.scrollTo({
        top: repliesContainer.scrollHeight,
        behavior: "smooth"
      });

      replyForm.reset();
      selectedFiles = [];
      previewContainer.innerHTML = "";
    } else {
      alert("Gagal mengirim pesan atau gambar");
    }
  });
});
</script>
</body>
</html>
